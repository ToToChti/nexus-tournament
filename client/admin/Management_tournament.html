<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Détails du Tournoi</title>
    <link rel="stylesheet" href="admin_management_tournament.css">
</head>
<body>
    <div class="container mt-5">
        <!-- Titre principal -->
        <div class="d-flex justify-content-center align-items-center header-container">
            <h1 class="header-title">Modifier un tournoi</h1>
        </div>

        <!-- Contenu principal -->
        <div class="main-content d-flex">
            <!-- Formulaire à gauche -->
            <div class="form-box">
                <p><strong>Nom du tournoi :</strong></p>
                <input type="text" placeholder="Nom du tournoi">

                <p><strong>Jeu :</strong></p>
                <input type="text" placeholder="Jeu">

                <p><strong>Nombre de Participants :</strong></p>

                <p><strong>Nombre de Spectateurs :</strong></p>

                <p><strong>Lieu :</strong></p>
                <input type="text" placeholder="Lieu">

                <p><strong>Date :</strong></p>
                <input type="date">

                <p><strong>Prix Minimal à l'inscription :</strong></p>

                <p><strong>Arbitres :</strong></p>
                <input type="text" placeholder="Arbitres">

                
                <p><strong>Sponsors :</strong></p>
                <input type="text" class="sponsors form-control" style="width: 20em;" placeholder="Sponsor">
                <span>à hauteur de :</span>
                <input type="number" step="0.01" class="hauteur_de form-control" style="width: 10em;" placeholder="€">

                <p><strong>Commentateurs :</strong></p>
                <input type="text" placeholder="Commentateurs">
            </div>

            <!-- Image et boutons à droite -->
            <!-- Image et boutons à droite -->
            <div class="right-section">
                <div class="tournament-image-box">
                    <label for="image-upload">Image du tournoi</label>
                    <img id="image-preview" src="#" alt="Aperçu de l'image" style="display: none; margin-top: 10px; max-width: 100%; border-radius: 5px;">  

                    <input type="file" id="image-upload" accept="image/*" onchange="previewImage(event)" style="display: none;"> 
                </div>
                <a href="admin_panel.ejs">
                    <button class="enregister">Enregistrer</button>
                </a>
                <a href="admin_panel.ejs">
                <button class="supp">Supprimer</button>
                </a>


                <div class="cash-prize-box">
                    <p><strong>Montant total du prize pool:</strong></p>
                    
                    <p><strong> 4000€</strong></p>
                </div>

                <div>
                    <button id="start_match_making" onclick=startMatchmaking()>Lancer le match macking</button>
                </div>
                <script>
                    document.getElementById('start_match_making').addEventListener('click', async () => {
                        // Récupère l'URL actuelle
                        const urlParams = new URLSearchParams(window.location.search);

                        // Extrait l'ID du tournoi
                        const tournamentId = urlParams.get('id');
            
                        try {
                            const response = await fetch('http://localhost:3000/matchMaking', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ id: tournamentId }),
                            });
            
                            if (response.ok) {
                                const data = await response.json();
                                document.getElementById('output').textContent = JSON.stringify(data);
                            } else {
                                console.error('Erreur dans la requête :', response.status);
                                document.getElementById('output').textContent = `Erreur : ${response.status}`;
                            }
                        } catch (error) {
                            console.error('Erreur lors de l\'appel API :', error);
                            document.getElementById('output').textContent = 'Erreur réseau ou interne.';
                        }
                    });
                </script>
                <div class="joueurs-inscrits">
                    <p><strong>Joueurs inscrits :</strong></p>
                    <ul>
                        <li>Joueur 1</li>
                        <li>Joueur 2</li>
                        <li>Joueur 3</li>
                        <li>Joueur 4</li>
                        <li>Joueur 4</li>
                        <li>Joueur 4</li>
                        <li>Joueur 4</li>
                        <li>Joueur 3</li>
                        <li>Joueur 4</li>
                        <li>Joueur 4</li>
                        <li>Joueur 4</li>
                        <li>Joueur 4</li>
                        <li>Joueur 3</li>
                        <li>Joueur 4</li>
                        <li>Joueur 4</li>
                        <li>Joueur 4</li>
                        <li>Joueur 4</li>
                    </ul>
                </div>

            </div>
            <div class="tournament-display" id="tournament-display"></div>
        </div>
    </div>

    <script>
    let players = [];

    async function fetchPlayers() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const tournamentId = urlParams.get('id'); // Récupère l'ID du tournoi depuis l'URL

            const response = await fetch(`http://localhost:3000/getPlayers/${tournamentId}`);
            if (response.ok) {
                const data = await response.json();
                players = data.players || [];
                console.log("Liste des joueurs récupérée :", players);
            } else {
                console.error("Erreur lors de la récupération des joueurs :", response.status);
            }
        } catch (error) {
            console.error("Erreur réseau ou interne :", error);
        }
    }

    let winners = [];
    async function startMatchmaking() {
        if (players.length === 0) {
            await fetchPlayers();
        }

        const tournamentDisplay = document.getElementById('tournament-display');
        tournamentDisplay.innerHTML = ''; // Réinitialise l'affichage

        currentRound = players;
        const firstRound = createRound(players, 1);
        tournamentDisplay.appendChild(firstRound);
    }

    // Appelez `fetchPlayers()` dès le chargement de la page
    fetchPlayers();

    // Fonction pour créer une nouvelle manche
    function createRound(players, numberRound) {
        const round = document.createElement('div');
        round.className = 'round';

        const roundTitle = document.createElement('div');
        roundTitle.className = 'round-title';
        roundTitle.textContent = `Round ${numberRound}`;
        round.appendChild(roundTitle);

        for (let i = 0; i < players.length; i += 2) {
            const match = document.createElement('div');
            match.className = 'match';

            const player1 = players[i];
            const player2 = players[i + 1];

            const player1Element = document.createElement('span');
            player1Element.textContent = player1;

            const player2Element = document.createElement('span');
            player2Element.textContent = player2;

            const button1 = document.createElement('button');
            button1.textContent = 'Gagnant';
            button1.onclick = () => {
                selectWinner(player1, match, numberRound);
            };

            const vsElement = document.createElement('span');
            vsElement.textContent = ' VS ';
            vsElement.style.fontWeight = 'bold';
            vsElement.style.color = '#fff';

            const button2 = document.createElement('button');
            button2.textContent = 'Gagnant';
            button2.onclick = () => {
                selectWinner(player2, match, numberRound);
            };

            match.appendChild(player1Element);
            match.appendChild(button1);
            match.appendChild(vsElement);
            match.appendChild(button2);
            match.appendChild(player2Element);
            round.appendChild(match);
        }

        return round;
    }

    // Fonction pour sélectionner un gagnant
    function selectWinner(winner, match, numberRound) {
        match.innerHTML = `<span class="winner">${winner}</span>`;
        winners.push(winner);

        if (winners.length === currentRound.length / 2) {
            setTimeout(() => nextRound(winners, numberRound), 500);
        }
    }

    // Fonction pour générer le prochain tour
    function nextRound(winnersList, numberRound) {
        winners = [];
        if (winnersList.length === 1) {
            alert(`Le gagnant du tournoi est : ${winnersList[0]}!`);
            return;
        }

        const tournamentDisplay = document.getElementById('tournament-display');
        const nextRoundElement = createRound(winnersList, ++numberRound);
        tournamentDisplay.appendChild(nextRoundElement);
        currentRound = winnersList;
    }

    </script>
</body>
</html>
